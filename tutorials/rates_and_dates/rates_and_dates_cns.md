---
标题: 估计具有时间标记序列的速率和日期
关键词: beast, 教程, 速率, 日期
最后更新: 2017.8.2
标签: [教程]
总结: "本章提供了对于不同时间点（异质数据）分离毒株组成的数据集的分步教程。在美洲，黄热病毒通常被引用的起源假说为源于非洲的埃及伊蚊，通过奴隶贸易期间的帆船舱底引入。尽管Bryant et al. (2007)在论文中已经提出奴隶贸易引入的假说，但是还没有通过用基因序列数据和现代系统发育技术相结合来估计其分歧时间的严格检验。本练习的目的是获得对分子进化速率的估计，最近的共同祖先的估计以及通过恰当的统计支持方法来推断系统发育关系。"
边注栏: beast_sidebar
永久链接: rates_and_dates.html
文件夹: beast
---

{% capture root_url %}{{ site.tutorials_root_url }}/rates_and_dates/{% endcapture %}

{% include warning.html content="This page unfinished." %}

数据集为来自非洲和美洲黄热病毒（YFV）的71条prM/E基因,其分离时间范围为1940-2009。
序列为Bryant等人分析的数据集的子集([Bryant JE, Holmes EC, Barrett ADT, 2007 Out of Africa: A Molecular Perspective on the Introduction of Yellow Fever Virus into the Americas. PLoS Pathog 3(5): e75](http://doi.org/10.1371/journal.ppat.0030075)).

{% include note.html content="本教程是介绍系列第三讲。本教程假设您已经完成了本网站的[第一](first_tutorial)和 [第二](second_tutorial)教程，并对BEAUti和BEAST的使用熟练。" %}

## 将数据导入BEAUti

<div>
<img src="images/icons/beauti-icon.png" style="max-width: 64px; float: left; margin: 0px" />
<div style="min-height: 64px; padding-top: 8px; margin-left:8px">
通过双击其图标运行[BEAUti](beauti)。
BEAUti 是一个交互式图形应用程序，用来分析和生成BEAST可以运行的控制文件(一个BEAST XML 文件)。
</div>
</div>

<div class="alert alert-success" role="alert"><i class="fa fa-download fa-lg"></i> 数据文件称作 '<samp>YFV.nex</samp>'， 可以在BEAST包的'<samp>examples/Data/</samp>' 文件夹找到或者<a href="{{ root_url }}files/YFV.nex">从此处下载</a>.</div>

### 导入NEXUS文件
导入NEXUS格式的文件，仅仅需要从`File`菜单选择`Import Data...`选项，然后选择`YFV.nex`文件。
该文件为71条YFV prM/E 基因序列，序列长度为654个核苷酸。
一旦导入，序列数据将会在“Data Partitions”列出:

{% include image.html prefix=root_url file="image1.png" %}

### 指定分类集

在`Taxa`面板，我们可以定义想获得某些特定统计的分类集群，强制执行单类群限制或者输入校准信息。
让我们通过点击面板左下侧的“+”来定义“美洲”分类群：

{% include image.html prefix=root_url file="image2.png" width="50%" %}<br />

 该步骤将创建一个新的分类群。
通过双击出现的条目（起初称作`untitled1`）来重新命名。
命名其为`Americas`。
由于我们要评估对该类群的支持，因此不来强制执行`monophyletic?`。
由于我们想估计来自美洲的病毒的TRMCA，而不是导致这个分支的父节点因此我们也不选择`includeStem?`。

在下一张表格您将看到可用的分类群。
通过点击绿色箭头按钮分类将会被选择并被移动到`Included taxa`。
注意可以分别按住Mac或PC上的“命令”或“控制”按钮同时选择多个分类。
由于多数分类来自美洲，最简便的方法是选中所有分类将其移动到‘Included taxa’ 集，然后将非洲分类移回非洲分类(取样国家包含在分类群名称末尾)。检查左侧仅有非洲国家(应该有21条) 右侧应该仅有美洲国家(应该有50条)。

对于更多创建分类群的信息，[详见本页](taxon_sets)。

完成以上操作后，屏幕应如下所示:

{% include image.html prefix=root_url file="image3.png" %}

为了让BEAUti/BEAST 识别序列的采样日期，请转到“Tips”菜单，选择“Use tip dates” 选项。默认情况下，所有分类的日期假设为0(即假设所有序列在同一时间采集；BEAST将当前或最近的采样时间视为时间0)。在本教程中，YFV序列的采样可以追溯到1940s不同日期。实际的采样年份在每个分类单元的名称中给出，我们可以在“Date column”简单地编辑表格中的日期以反映这些值。但是，如果分类单名称包含校准信息，则在BEAUti中指定序列日期的便捷方法是使用在"Data"面板顶部的`Parse Dates`按钮。单击此按钮将显示一个对话框：

{% include image.html prefix=root_url file="image4.png" %}

此操作尝试从分类单名称包含的信息中猜测日期。它的工作原理是尝试在每个名称中找到一个数字字段。如果分类单元名称包含多个数字字段(例如上面的一些YFV序列)，那么您可以指定如何找到与采样日期对应的数字字段。[有关此面板中对于设置日期的不同选项的详细内容，请参阅此页面](tip_dates)。对于YFV序列分析，可以保持默认的`Defined just by its order`以及 `Order: first`(请注意确保选中的`Parse as a number`选项)。

在解析数字时，可以要求BEAUti为每个日期添加固定值，此应用有益于[将2位数的年份转换为4位数字的年份](tip_dates)。由于在本教程中所有的日期被指定为4位数字的格式，没有必要再添加额外的设置。因此，我们可以点击`OK`。

{% include image.html prefix=root_url file="image5.png" %}

`Height` 列列出了相对于时间0的时间提示(本教程是2009)。对于本教程的这些序列仅提供了采样年份，并没有确切的日期。考虑到该例子相对较大的进化时间尺度，其不确定性可以忽略，然而，[可以调整采样时间的不确定性--- 详见此处](sampling_tipdates)。

### 设置进化模型

接下来要做的是点击主窗口顶端的"Sites"选项。该选项将会揭示对于BEASTd的进化模型的设置。哪些选项会出现取决于数据是核苷酸还是氨基酸(或者性状)。本教程假设您熟悉可用的进化模型;然而BEAUti中选择模型还有几点需要注意:

分区到密码子位置:
: `Partition into codon positions` 选项假定数据为比对好的密码子。该选项会为每个密码子的不同位置估计其独立的进化速率，或者是第1+2位vs第3位的进化速率，这取决于您的设置。

独立考虑不同位密码子的进化速率模型:
: `Unlink substitution model across codon positions`选项指定BEAST应为每个密码子位置估计单独的转换 -颠换比率或一般时间可逆速率矩阵。

独立考虑不同位密码子的速率异质性模型：
: `Unlink rate heterogeneity model across codon positions`选项指定BEAST应为每个密码子位置估计单独的速率异质性参数(伽马形状参数以及/或者不变位点的比例)。

独立考虑不同位密码子的碱基频率:
: `Unlink base frequencies across codon positions`选项指定BEAST应为每个密码子位置估计独立的碱基频率。

 本教程中，选择3个分区: 密码子1,2&3位，即每个密码子位置有其独立的HKY替代模型，进化速率，碱基频率以及位点的伽马分布分部率变量:

{% include image.html prefix=root_url file="image6.png" %}

### 设置分子钟模型

点击主窗口顶端的“Clocks” 面板。我们将使用(默认)严格分子钟模型执行初始运行：
 
{% include image.html prefix=root_url file="image7.png" %}

### 设置起始树和树先验分布

点击主窗口顶端的“Tree” 面板。我们保留默认的随机起始树和(简单)恒定大小的聚合先验分布。树的先验分布(聚合和其他模型) [在此页面详细介绍](tree_priors)

{% include image.html prefix=root_url file="image8.png" %}

### 设置先验分布

查看`Priors` 面板下的设置:

{% include image.html prefix=root_url file="image9.png" %}

<!--一些默认的边际先验值可能是不合适的(如黄色显示的)； 没有设置的先验值将会显示红色。由于不合适的先验分布将会导致不合理的后验概率和边际似然值（当选择贝叶斯模型时，在该教程中见其详细解释），因此为所有估计的参数提供合适的先验分布非常重要。比如改变相对速率的先验分布(allMus)，点击其相关先验分布，先验选择窗口将会出现。设置其先验分布为伽马分布，shape = 0.001 and scale = 1000。此先验分布的图形表示表示大多数先验分布都分布在较小的值上,但密度仍然足够分散。请注意,在通过单击"OK"确认此设置后,上一个设置将变为黑色。

注意对进化速率(clock.rate)的默认先验分布是条件参考先验分布的近似值(Approx. Reference Prior) (Ferreira and Suchard, 2008)。如果序列不是不同时间点采样的(同时间采样)，或者,当采样时间范围对于分类的进化尺度来说微不足道时,替换率可以基于其他来源固定为某一值,或者更好的是,可以指定一个先验分布,纳入此"外部"速率的不确定性。 将速率固定为1.0将会导致对树的节点年龄的估计以每个位点的替换为单位(比如在一些广泛使用包（MrBayes）里的分支长度的常见单位）。请注意，当选择将速率固定为某一值的时候，其参数的转换核 (‘Operators’ 面板，见下一部分) 将会自动取消选择。 -->

### 设置采样模块

模型中每个参数都有一个或多个"采样模块"(他们通常被其他的MCMC软件包如MrBayes和LAMARC称为移动，建议或转换内核)。采样模块指定当MCMC运行时参数是如何改变的。对于BEAST v1.8.4，不同的选项可以用来分析树的空间。本教程我们将会用‘经典运行模块的混合’，它由一组树转换内核组成，这些内核建议对树进行更改。还有一个选项是用来固定树的拓扑结构以及一个“新的实验组合”，该选项目前正在开发中，目的是改善较大的系统发育树的聚合。

在BEAUti的`operators` 面板的列表列出了参数，对应参数的采样模块以及其调整设置：

{% include image.html prefix=root_url file="image10.png" %}

第一列是参数名称。这些被称为类似于`CP1.kappa`的参数，CP1.kappa为第一位密码子HKY模型中的kappa参数(转换- 颠换偏差)。下一列为作用于每个参数的运采样模块。例如，“scale operator”采样模块通过随机比例向上或向下缩放参数，“统一采样模块”只是在一个范围内统一选取一个新值。与树或树中的节点年龄相关的一些参数与特定采样模块相关。

标记为“Tuning”的一列，为采样模块提供调整设置。某些没有调整设置的采样模块在该列列出n/a。调整设置参数决定了每个采样模块将进行多大的移动，这将影响MCMC接受的更改的频率，从而影响分析效率。对于多数采样模块(如亚分支树采样模块“subtree slide operator”)大的调整参数意味着较大的移动。然而，对于比例采样模块“scale operator“，调整参数值接近0.0意味着更大的移动。在主窗口有一个称为“Auto Optimize”选项，当选择该选项时，将在MCMC运行时自动调整设置以尝试实现最高效率。在运行结束时，可以将采样模块，它们的性能和这些调整设置的最终值写入标准输出。

标记为“Weight”的一列,指定每个采样模块相对于其他采样模块的应用频率。一些参数倾向于从它们的目标分布有效地采样(如kappa参数)；这些参数可以使其采样模块符降低权重，以便它们不会被经常修改。我们将对本教程分析从默认设置开始。

### 设置MCMC选项

BEAUti中的MCMC选项卡提供控制MCMC链的设置。首先是链的长度。这是MCMC在完成之前在链中所做的步数。这取决于数据集的大小，模型的复杂性和所需回答问题的精确度。默认值10,000,000完全是随机的，应根据数据集的大小进行调整。稍后我们将看到如何使用Tracer分析生成的log文件，来检查特定链长是否足够。

{% include image.html prefix=root_url file="image11.png" %}

接下来两个选项指定当前参数值应在屏幕上显示并记录在log文件中的频率。屏幕输出仅用于监测程序的进度，因此可以设置为任意值(尽管设置得太小，屏幕上显示的信息量将减慢程序的运行速度)。对于log文件，应该相对于链的总长度设置该值。过于频繁的采样将导致非常大的文件，在估计的精确度方面几乎没有额外的好处。样本太少，log文件中包含有关参数分布的信息较少。您可能希望存储不超过10,000个样本，因此应将其设置为大于等于链链长的万分之一/。

对于本数据集，我们最初将链长设置为100,000，因为这将在多数现代计算机上运行的相当快。尽管根据以上建议表明较低的采样频率，本数据将采样频率设置为100。
下一个选项允许用户设置文件主干名称；如果不默认设置为‘YFV’，则可在此处输入。接下来的两个选项给出了log文件的参数和树的文件名。根据文件主干名，将其设置为默认值。我们还可以通过选择相关选项来创建采样模块分析文件。还可以选择仅从先验分布采样的选项，这可用于评估从数据中提取信息时我们的后验估计的差异。在这里，我们不会选择此选项，而是分析实际数据。最后，也可以选择进行边际似然估计来评估模型拟合; 我们将在本教程的后面部分返回。

此时，我们已准备好生成BEAST XML文件并使用它来运行贝叶斯进化分析。要执行此操作，请从“File”菜单中选择“Generate BEAST File...”选项，或单击窗口底部的类似标记的按钮。BEAUti将要求您在保存文件之前再次查看先验设置(并指出某些不合适的设置)。继续并选择文件的名称(如，YFV.xml)并保存文件。

为方便起见，请保持BEAUti窗口处于打开状态，以便您可以根据本教程后面的要求更改值并重新生成BEAST文件。

## 运行BEAST

一旦创建BEAST XML文件后，可以使用BEAST运行其分析。运行BEAST的确切说明取决于您使用的计算机，但在大多数情况下，将出现一个标准文件对话框，您可以在其中选择XML文件：如果正在使用命令行版本，则会在BEAST可执行文件的名称之后给出XML文件的名称。当安装了BEAGLE库(code.google.com/p/beagle-lib/)后，可以将其与BEAST结合使用以加快计算速度。如果未安装，请取消选择BEAGLE库的使用。按“Run”时，将执行分析，其中包含有关正在写入屏幕的运行进度的详细信息。完成后，将在与XML文件相同的位置创建log文件和树文件。

## 分析BEAST的输出

为了分析运行BEAST的结果，我们将使用Tracer程序。运行Tracer的确切说明因您使用的计算机而异。请参阅随您下载的版本的README文本文件。一旦运行，无论它运行在哪个计算机系统上，Tracer都看起来相似。

从`File`菜单选择`Import Trace File...`。如果可用，请选择您在上一讲中创建的log文件。该文件将加载，您将看到一个类似于下面的窗口。请记住，MCMC是一种随机算法，因此实际数字不会完全相同。

在左侧是加载的log文件的名称及其包含的跟踪。存在与后验概率成比例的量的痕迹（这是数据似然和先验概率，对数尺度的乘积 的产物）和连续参数。选择左侧的痕迹迹会根据所选的选项卡在右侧显示此痕迹的分析。首次打开时，将posterior选择跟踪，并在“估计”选项卡下显示此跟踪的各种统计信息。`posterior` 会被选择追踪，并在“估计”选项卡下显示此追踪的各种统计信息。

在窗口的右上角是一个计算所选跟踪统计信息的表。统计数据及其含义如下表所示。

平均值
: 样本(排除老化)的平均值。

平均值的标准误
: 平均值的标准误差。这考虑了有效的样本大小，因此小的ESS会产生很大的标准误差。

中位数
: 样本(排除老化)的中值。

几何平均数
: 样本集(排除老化)的中心趋势或典型值。

95% HPD的下限
: 最高后验概率密度(HPD)间隔的下限。HPD是包含95％采样值的最短间隔。

95% HPD的上限
: 最高后验概率密度(HPD)间隔的上限。

自相关次数(ACT)
: MCMC链中的平均状态数，由于不相关，两个样本独立分开(即来自后验概率的独立样本)。ACT是根据追踪中的样本(排除老化)估算的。

有效样本大小(ESS)
: 有效样本大小(ESS)是与追踪中等价的独立采样数。通过链长(排除老化)/ACT获得。

注意所有追踪的有效样本大小(ESSs)都较小(在Tracer中ESSs小于100会被红色高亮，>100但<200会被黄色高亮)。这并不好。低的ESS值意味着追踪过程中包含许多相关样本，可能并不能很好地代表后验概率的分布。在窗口的右下角是样本的取样频率图，该图假设低ESS非常粗糙。
如果我们选择了右侧标签为“Trace”的选项卡，我们可以查看原始跟踪，即MCMC链中步骤的采样值。
在这里可以看到样本的相关性。在追踪中有1000个样本(我们运行MCMC100,000步，每100步采样一次)，但很明显，相邻的样本往往具有相似的值。根节点年龄的ESS值(treeModel.rootHeight)大约为6，因此每167次实际采样获得一个独立的样本)。看起来链长的10％的默认老化是不充分的(在大多数链中后验概率仍在上升)。不排除足够的链长起始步数作为老化将使结果偏差并使ESS的估计不可靠。
对这种情况的简单回应是我们需要将链长运行更长。返回上面的“MCMC Options”部分，创建一个链长较长(例如10.000.000)的新BEAST XML文件。要继续学习本教程而不必等待很长时间才能完成,您可以使用本教程提供的log文件 (链长20.000.000，每10,000 个样本记录一次)。导入log文件进行严格分子钟分析，点击"Trace"键查看原始的追踪图。

提供的log文件包含2000个样本，clock.rate的ESS值为262，样本之间仍存在一定程度的自相关性，但是262个有效的独立样本现在可以为后验概率分布提供合理的估计。该图中没有明显的趋势表明MCMC尚未收敛，并且在追踪中没有大规模波动，这表明混合不好。
由于我们对后验概率的行为感到满意，我们现在可以转向感兴趣的参数之一：替代率。选择左侧的clock.rate。这是比对文中所有位点的平均替换率。通过选择"Marginal Prob Distribution"的选项卡来选择密度图。该图表示的是该参数的后验概率密度的核密度(KDE)估计。您应该看到类似于下面的图:



正如您所看到的，后验概率密度很好地呈钟形。当查看在估计面板中等价的直方图时，会有一些采样噪声被KDE平滑化;如果我们将链长运行更长，这将会减少，但我们已经对平均值和HPD间隔进行了合理估计。您可以重合多条轨迹线的密度图以进行比较(由用户决定它们是否在同一轴上具有可比性)。选择左边表格中所有三个密码子位置的相对替代率(标记为CP1.mu， CP2.mu和CP3.mu，在“Legend”下选择‘Top-Right’。将显示覆盖所有三个密码子位置的相​​对替换率的后验概率密度：

请注意，这三个比率明显不同，这告诉我们这个基因的选择压力是什么？现在让我们来看下相对于总体共同祖先，来自于美洲毒株的最近共同祖先(tmrca):

这表明美洲的最近共同祖先明显比根节点年轻，并且认为最近的YFV来源美洲。

## 总结树

我们已经看到如何使用Tracer诊断MCMC的运行并产生对模型参数的边际后验概率分布的估计。然而，BEAST也会与模型的其他参数同时对树进行采样(系统发育或谱系)。这些将会被单独写入`trees'文件。该文件是标准的NEXUS格式文件。因此，它可以很容易地加载到其他软件中，以检查它包含的树。一种可能性是将树加载到诸如PAUP*之类的程序中，并以类似的方式构建一致树以概括一组自展值树。在本例子中，在一致树中已解析节点所报道的支持值是这些分支的后验概率。

然而在本教程中，我们将用BEAST包中的一个工具来总结存在于我们取样树中的信息。该工具为TreeAnnotator，一旦运行，将会看到类似于以下窗口的展示。

TreeAnnotator 总结的是一个`目标'树，并且将整个采样树中获得的信息将其注释。总结的信息包括平均节点年龄(带有HPD间隔的)，后验支持以及每个分支的平均进化速率(对于变化的模型)。程序为在指定的“目标”树中观察到的每个节点或分支计算这些值。
老化- 输入文件中应该从总结树中排除的状态数或树树。该值是以树的数量给出，而不是MCMC链中的步数。因此，对于以上例子，链长为20,000,000步，以状态数量的10％的老化生成为2,000,000个状态。或者，链长为20,000,000步，每10000步取样一次，文件中会有2000棵树。要获得10％的老化，请将树的数量的“burnin”设置为200。
后验概率限制- 这是节点的最小后验概率，为了让TreeAnnotator储存带注释的信息。将此值保留为默认值0.0以总结目标树中的所有节点。
目标树的类型-有两个选项"最大分支可信度"或者"用户目标树"。对于后一种选项，可以将NEXUS树文件指定为下面的目标树文件。对于前一个选项，TreeAnnotator将检查输入树文件中的每个树，并选择具有其所有节点的后验概率的最高乘积的树。

节点高度-此选项指定应将哪个节点高度(时间)用于输出树。如果选择’保持目标高度’，节点的高度将会与目标树一致。节点高度也可以概括为树样本的均值或中值。有时，节点的平均或中值高度实际上可能高于其父节点的平均或中值高度(因为与大量其他采样的树相比，MCC树中的特定祖先-后代关系可能仍然不同)。这将导致人工负分支长度，但可以通过"共同祖先高度”选项来避免。让我们使用默认的中位数高度作为摘要树。让我们使用默认的中位数高度作为总结树。

目标树文件-如果选择"User target tree"，你可以从"Choose File..." 来选择包含目标树的NEXUS文件。

输入树文件-用"Choose File..." 来选择输入树文件。这将是BEAST生成的树文件。

输出文件-选择输出树文件的名称(如，YFV.MCC.tre)。

一旦选择以上所有选项，点击"Run"。TreeAnnotator将会分析输出文件并将总结树写入到您指定的文件。此树是标准的NEXUS树文件格式，因此可以加载到支持此树的任何树绘图包中。但是，它还包含只能使用FigTree来显示的额外信息。

### 查看带注释的树

现在运行FigTree并从文件菜单中选择“打开.....”命令。选择在上一节中使用TreeAnnotator创建的树文件。树将会展示在FigTree窗口。在窗口的左侧是控制树显示方式的选项和设置。在本教程，我们希望显示树中存在于每个进化枝的后验概率以及每个节点的年龄估计。为此，您需要更改一些设置。

首先，通过树菜单下的增加节点顺序重新排序节点顺序。单击左侧控制面板中的“分支标签”，然后单击左侧的箭头打开相关部分。现在在"Display"选项下选择“Operator”。这种注释的相对大小也可以由节点形状表示。

我们还可以为此进化史绘制时间轴(选择‘Scale Axis’ 并取消‘Scale bar’)。要进行适当的缩放，打开‘Time Scale’部分的控制面板，设置‘Offset’为2009.0，比例因子为-1.0，选择‘Scale Axis’下的‘Reverse Axis’。

最后，打开“Appearance” 面板，更改"Line Weight"以使用较粗的线条绘制树。还可以通过选择分支，选择‘Clade’选择模式并选择一种颜色来为分组上色。这些选项实际上都不会改变树的拓扑或分支长度，因此可以随意浏览选项和设置(比如高亮或折叠美洲分支)。您也可以保存树，这将保存您的大多数设置，以便当您再次将其加载到FigTree时，它将显示几乎与您选择的完全相同。树也可以导出到图形文件(pdf, eps, 等)。
来自美洲的病毒是如和与来自非洲的病毒产生联系的，以及我们可以从推断的时间尺度的出什么结论？

{% include links.html %}
